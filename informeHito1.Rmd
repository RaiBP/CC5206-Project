---
title: "Crisis medioambiental en Quintero y Puchuncaví: Análisis de egresos hospitalarios período 2002-2017 *(sujeto a cambios)*"
output: html_document
header-includes:
  - \usepackage{amsmath}
  - \usepackage{mathtools}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

Con el fin de mostrar de manera más explícita el problema al que se enfrenta la comuna de Quintero y Puchuncaví, junto con analizar los problemas que pueden venir a futuro, se utilizan herramientas de minería de datos para comparar distintos aspectos de la comuna con respecto a otras comunas y a nivel país.

## Contextualización del problema

Recientemente se ha descubierto que los niveles de contaminación en las comunas de Quintero y Puchuncaví alcanzaron niveles críticos debido a malas regulaciones de industrias en la zona, esto ha provocado el aumento de distintas enfermedades y es probable que siga aumentando.

## Datos a utilizar

Para el presente análisis se utilizan los datos de egresos hospitalarios desde el año 2002 al año 2017 dados por el Departamento de Estadísticas e Información de Salud (2017), los cuales dan cuenta de el establecimiento, la comuna, la región, el diagóstico del egreso (según norma CIE-10), entre otros atributos. Se trabajará también con los datos de la proyección de población entre 2002 al 2020 dado por el Instituto Nacional de Estadísticas (2014), separados por comuna y sexo. Por último, se utilizan los datos del Sistema de Información Nacional de Calidad del Aire (2018), específicamente los índices de concentración de dióxido de azufre (SO2) y material particulado respirable con diámetro menor o igual a 10 $\mu$m (MP10) registrados anualmente en estaciones de monitoreo en las comunas de Quintero y Puchuncaví, entre 1993 y 2018.

## Análisis exploratorio de los datos

### Preliminares

Para analizar los datos se utilizarán conceptos prestados de la epidemiología, disciplina que se encarga de estudiar la distribución de las enfermedades en la población y los factores que influyen en tal distribución. Primero se definirá la  **tasa de incidencia** o simplemente incidencia de una enfermedad como "el número de casos nuevos que ocurren en un período de tiempo específico en una población en riesgo de contraer la enfermedad" (Gordis, 2014, p. 41). 

Si bien los egresos hospitalarios no dan cuenta completamente de los nuevos casos de una enfermedad, pues los casos de gente hospitalizada por una enfermedad tiende a ser mucho menor que los casos de gente con la enfermedad en sí, como el objetivo de este estudio no es realizar un estudio epidemiológico riguroso, se considerará el número de egresos hospitalarios en un año para una enfermedad dada como "el número de casos nuevos en un período de tiempo específico" (siendo el período de tiempo específico un año) y por lo tanto, en cuanto a este análisis concierne, podrán serán usados para calcular la incidencia de la enfermedad.

Con el objetivo de aplicar el concepto al estudio en cuestión, se define $\mathcal{A}=\{2002,...,2017\}$ como el conjunto de los años en estudio y $\mathcal{D}$ el conjunto de los posibles diagnósticos dados por el CIE-10, se tiene entonces que para $a \in \mathcal{A}$ y $d \in \mathcal{D}$, se define la tasa de incidencia del diagnóstico $d$, en el año $a$ y para una población cualquiera $\mathcal{X}$,  $\text{I}_{(a,d)}(\mathcal{X})$, como: 

$$\text{I}_{(a,d)}(\mathcal{X})=\frac{\text{N}_{(a,d)}(\mathcal{X})}{\text{P}_{a}(\mathcal{X})}$$

<!-- Donde $N_{a,d}(\mathcal{X})$ es el número de egresos en el año $a$ de pacientes provenientes de $\mathcal{X}$ con el diagnóstico $d$ y $P_{a}(\mathcal{X})$ es la cantidad de personas en $\mathcal{X}$ en el año $a$. Usando los datos del Censo 2017, se definirá la función $\xi$ como: -->

<!-- $$ -->
<!--   \begin{align*} -->
<!--       \xi \text{: } &\mathcal{C} \to \mathbb{R}^{161}\\ -->
<!--        &c \mapsto \xi(c) = (\xi_0(c),...,\xi_{161}(c)) -->
<!-- \end{align*} -->
<!-- $$ -->
<!-- Donde $\xi_i$ está dado por: -->

<!-- $$ -->
<!--   \begin{align*} -->
<!--      \xi_i(c)= \begin{cases} -->
<!--     \#\text{hombres de edad }i\text{ de la comuna }c\text{ en el año 2017}& \text{si } i=0,...,80\\ -->
<!--     \#\text{mujeres de edad }i-81\text{ de la comuna }c\text{ en el año 2017}& \text{si } i=81,...,161 -->
<!--     \end{cases} -->
<!-- \end{align*} -->
<!-- $$ -->

<!-- Denotando $\mathcal{C}\setminus\{c\}\equiv\mathcal{C}_0$, se definirá la comuna más cercana demográficamente a $c$ como la comuna $c_0 \in \mathcal{C}_0$ tal que: -->

<!-- $$ -->
<!-- c_0=\arg \min_{h \in \mathcal{C}_0} \left\lVert \xi(c)-\xi(h) \right\rVert  -->
<!-- $$ -->

Para estudiar qué tan fuerte es la asociación entre la exposición a cierto factor ambiental y el desarollo de una enfermedad, se seleccionan dos poblaciones, $\mathcal{X}$ y $\mathcal{X}_{0}$, donde la primera está expuesta a tal factor ambiental y la segunda no, y se define el **riesgo relativo** como el cociente entre la incidencia de la enfermedad en la primera población y la incidencia de la enfermedad en la segunda (Gordis, 2014, p. 218).  Por lo tanto, en el contexto del presente análisis, para un año $a$ y un diagnóstico $d$, se definirá el riesgo relativo $\text{RR}_{(a,d)}(\mathcal{X},\mathcal{X}_{0})$ entre la población expuesta, $\mathcal{X}$, y la no expuesta, $\mathcal{X}_{0}$ como:

$$
\text{RR}_{(a,d)}(\mathcal{X},\mathcal{X}_{0})=\frac{\text{I}_{(a,d)}(\mathcal{X})}{\text{I}_{(a,d)}(\mathcal{X}_{0})}
$$

### Análisis

Dado el dataset de egresesos hospitalarios, se contabilizó el número de casos para cada diagnóstico, comuna y año. Como se considera como población expuesta a las comunas de Quintero y Puchuncaví, y la población no expuesta como el resto del país, para obtener los riesgos relativos de cada diagnóstico, se deben calcular las incidencias de Quintero, de Puchuncaví y la del resto del país. Las primeras dos son fáciles de calcular, pues para cada diagnóstico y año basta dividir el número de casos por la población de Quintero o Puchuncaví, en el año correspondiente. Para calcular la incidencia del resto del país para cierto diagnóstico y un cierto año, se deben sumar los casos de todas las comunas del país, excepto Quintero y Puchuncaví, y dividir este número por la suma de las poblaciones de todas las comunas, excepto Quintero y Puchuncaví. De esta forma, se obtiene el **riesgo relativo nacional** de Quintero usando la fórmula de riesgo relativo recién expuesta y eligiendo $\mathcal{X} = \text{Quintero}$ y $\mathcal{X}_{0} = \text{Chile menos Quintero y Puchuncaví}$. Similarmente, se obtiene para Puchuncaví eligiendo $\mathcal{X} = \text{Puchuncaví}$. Promediando el riesgo relativo con respecto a los años, se pueden ordenar los diagnósticos de mayor a menor riesgo relativo nacional promedio. Seleccionando los 300 primeros diagnósticos con mayor riesgo relativo nacional promedio en Quintero y en Puchuncaví, y tomando la intersección de estos, se obtienen 46 diagnósticos, los 20 primeros (ordenando según el promedio entre Quintero y Puchuncaví) se muestran a continuación:

<center>
```{r echo=FALSE,fig.cap="Figura 1. Los 20 primeros diagnósticos con mayor riesgo relativo nacional promedio.",fig.pos = 'p', fig.width=10,fig.height=6}
library(ggplot2)
library(reshape2)

incidencia <- read.csv("datasets\\RRnacionalFinal.csv", header=TRUE)
is.na(incidencia) <- sapply(incidencia,is.infinite)

diagInteres <- intersect(incidencia[order(incidencia$meanQ, decreasing = T),][1:300,"id10"],incidencia[order(incidencia$meanP, decreasing = T),][1:300,"id10"])

incidenciaInt <- incidencia[incidencia$id10 %in% diagInteres,]
incidenciaInt <- incidenciaInt[order(incidenciaInt$mean, decreasing = T),][1:20,]

ggplot(melt(incidenciaInt[,c("meanQ","meanP","dec10","mean")], id.vars=c("mean","dec10")), aes(x=reorder(dec10, mean), y=value)) +   
  geom_bar(aes(fill = variable), position = "dodge", stat="identity") +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(fill="Comuna") +
  scale_fill_discrete(labels = c("Quintero","Puchuncaví")) +
  ggtitle("Diagnósticos con mayor riesgo relativo nacional") + 
  xlab("Diagnóstico") + ylab("Riesgo relativo c/r a incidencia nacional, promediado de 2002 a 2017")+
  scale_y_continuous(breaks = seq(0, 320, by = 20))
```

</center>

Es importante mencionar que un riesgo relativo $>1$ ya indica una asociación positiva entre la enfermedad y el factor ambiental al que la población en estudio está expuesta, e indica una posible causalidad (Gordis, 2014, p. 217). Es por esto que es muy interesante encontrar riesgos relativos nacionales tan altos, pues indican que existe una gran asociación entre los factores de riesgo presentes en Quintero y Puchuncaví, y los diagnósticos correspondientes. De este modo, se seleccionarán algunos de los diagnósticos con mayor riesgo relativo nacional para un mayor análisis, en particular, un análisis temporal. 





En cuanto a los datos de la contaminación del aire provistos por el SINCA (2018), se obtienen los siguientes gráficos (donde no se tiene información en el año 2011 para Quinter): 
<center>
```{r echo=FALSE,fig.cap="Figura 2. Concentración de SO2 en Quintero y Puchuncaví a lo largo de los años.",fig.pos = 'p', fig.width=10,fig.height=5}
library(ggplot2)
library(reshape2)

source("scripts\\obtenerContaminacion.R")

QSO2 <- read.csv("datasets\\contaminacion\\QSO2.csv", header=TRUE)
QMP10 <-  read.csv("datasets\\contaminacion\\QMP10.csv", header=TRUE)
PSO2 <- read.csv("datasets\\contaminacion\\PSO2.csv", header=TRUE)
PMP10 <-  read.csv("datasets\\contaminacion\\PMP10.csv", header=TRUE)

SO2 <- data.frame(PSO2[,c("Fecha","mean")],QSO2[,"mean"])
colnames(SO2) <- c("Fecha","Puchuncavi","Quintero")

SO2long <- melt(SO2, id="Fecha")

colnames(SO2long)[2] <- "Comuna"

ggplot(data=SO2long,
       aes(x=Fecha, y=value, colour=Comuna)) +
  geom_line(size=2)+
  geom_point(size=4, na.rm=TRUE)+
  ggtitle("Concentración de SO2 en la atmósfera, Quintero y Puchuncaví") + 
  xlab("Año") + ylab("Concentración de SO2 en atmósfera (ppb)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  scale_x_continuous(breaks = SO2$Fecha)


MP10 <- data.frame(PMP10[,c("Fecha","mean")],QMP10[,"mean"])
colnames(MP10) <- c("Fecha","Puchuncavi","Quintero")

MP10long <- melt(MP10, id="Fecha")

colnames(MP10long)[2] <- "Comuna"
```

```{r echo=FALSE,fig.cap="Figura 3. Concentración de MP10 en Quintero y Puchuncaví a lo largo de los años.",fig.pos = 'p', fig.width=10,fig.height=5}
ggplot(data=MP10long,
       aes(x=Fecha, y=value, colour=Comuna)) +
  geom_line(size=2)+
  geom_point(size=4, na.rm=TRUE)+
  ggtitle("Concentración de MP10 en la atmósfera, Quintero y Puchuncaví") + 
  xlab("Año") + ylab("Concentración de MP10 en atmósfera (μg/m3N)")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  scale_x_continuous(breaks = MP10$Fecha)
```

</center>

Se ve claramente un peak de ambas concentraciones y en ambas localidades alrededor del año 1995. También se nota que el MP10 en Quinterp ha estado en aumento la última década, pero el resto de indicadores se han mantenido relativamente constantes en este mismo período en ambas localidades.

Como resultado parcial del análisis de los datos obtuvimos lo siguiente:
```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('plots\\quin_prom.png')
```
Este gráfico muestra las enfermedades de mayor incidencia en Quintero, donde el mayor riesgo es presentado con la supervisión del embarazo, seguido por infecciones mientras dura el embarazo y la diabetes.

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('plots\\puch_prom.png')
```
En este otro gráfico se muestra, al igual que el anterior, las enfermedades de mayor incidencia, pero en este caso en Puchuncavi.

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics('plots\\SindromeNefriticoQSO2.png')
```
En el gráfico de arriba se observa una especie de efecto retardado sobre la incidencia de Síndrome Nefrítico en Quintero y Puchuncavi





## Conclusión

## Referencias

Gordis, L. (2014). *Epidemiology* (5ta ed.). Philadelphia, PA: Elsevier Saunders. 

Ministerio de Salud, Departamento de Estadísticas e Información de Salud (DEIS) (2017). *Egresos Hospitalarios 2001-2017* [Dataset]. Gobierno de Chile. Recuperado de: https://reportesdeis.minsal.cl/Egresos2001_2016/egresos_2003/egresos.asp

Instituto Nacional de Estadísticas (INE) (2014). *Proyección de población 2002 - 2020 (actualización 2014). Comunas: Población por sexo y edad simple* [Dataset]. Gobierno de Chile. Recuperado de: http://www.ine.cl/estadisticas/demograficas-y-vitales

Ministerio del Medio Ambiente, Sistema de Informacion Nacional de Calidad del Aire (SINCA) (2018). *Registros de calidad del aire* [Dataset]. Gobierno de Chile. Recuperado de: https://sinca.mma.gob.cl/index.php/busqueda?cache=off&
